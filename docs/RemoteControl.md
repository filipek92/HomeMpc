# Solax RemoteControl - Modbus Power Control

## √övod

RemoteControl je pokroƒçil√° funkce pro Solax Gen4 hybridn√≠ st≈ô√≠daƒçe, kter√° umo≈æ≈àuje p≈ô√≠m√© ≈ô√≠zen√≠ v√Ωkonu p≈ôes Modbus protokol. Na rozd√≠l od standardn√≠ch power control p≈ô√≠kaz≈Ø, kter√© se ukl√°daj√≠ do EEPROM, RemoteControl p≈ô√≠kazy jsou doƒçasn√© a mohou b√Ωt vol√°ny libovolnƒõ ƒçasto bez rizika opot≈ôeben√≠ pamƒõti.

## V√Ωhody RemoteControl

### 1. Bez omezen√≠ na z√°pisy
- **Standardn√≠ ≈ô√≠zen√≠**: Ukl√°d√° se do EEPROM ‚Üí omezen√Ω poƒçet z√°pis≈Ø (nevhodn√© pro automatizace)
- **RemoteControl**: Doƒçasn√© p≈ô√≠kazy v RAM ‚Üí neomezen√Ω poƒçet z√°pis≈Ø
- **Ide√°ln√≠ pro**: ƒåast√© zmƒõny v automatizac√≠ch (ka≈æd√Ωch 5-60 sekund)

### 2. ≈Ωivotn√≠ cyklus p≈ô√≠kaz≈Ø
- **Doba platnosti**: Omezen√° (standardnƒõ 20 sekund)
- **Autorepeat**: Automatick√© obnovov√°n√≠ p≈ô√≠kaz≈Ø v definovan√Ωch intervalech
- **Flexibilita**: Mo≈ænost okam≈æit√©ho zastaven√≠ nebo zmƒõny re≈æimu

### 3. Emulace standardn√≠ch re≈æim≈Ø
- **Self Use Mode**: Emulace standardn√≠ho re≈æimu vlastn√≠ spot≈ôeby
- **Feedin Priority**: Emulace re≈æimu preferovan√©ho exportu
- **Grid Control**: P≈ô√≠m√© ≈ô√≠zen√≠ v√Ωkonu na s√≠≈•ov√©m rozhran√≠
- **Battery Control**: P≈ô√≠m√© ≈ô√≠zen√≠ v√Ωkonu na bateriov√© rozhran√≠

## Dostupn√© parametry

### Hlavn√≠ ovl√°dac√≠ entita
- **`remotecontrol_trigger`**: Tlaƒç√≠tko pro aktivaci nov√©ho RemoteControl slotu

### Konfigurace ≈ô√≠zen√≠
- **`remotecontrol_power_control`**: Re≈æim ≈ô√≠zen√≠ v√Ωkonu
  - `"Disabled"` - vypnuto
  - `"Enabled Power Control"` - p≈ô√≠m√© ≈ô√≠zen√≠ aktivn√≠ho v√Ωkonu
  - `"Enabled Grid Control"` - ≈ô√≠zen√≠ v√Ωkonu na s√≠≈•ov√©m rozhran√≠
  - `"Enabled Battery Control"` - ≈ô√≠zen√≠ v√Ωkonu na bateriov√© rozhran√≠  
  - `"Enabled Self Use"` - emulace self-use re≈æimu
  - `"Enabled Feedin Priority"` - emulace feedin priority re≈æimu
  - `"Enabled No Discharge"` - z√°kaz vyb√≠jen√≠ baterie

### V√Ωkonov√© parametry
- **`remotecontrol_active_power`**: C√≠lov√Ω aktivn√≠ v√Ωkon (W)
  - Kladn√© hodnoty = nab√≠jen√≠/import
  - Z√°porn√© hodnoty = vyb√≠jen√≠/export
  - Automaticky omezeno na rozsah `active_power_lower` a≈æ `active_power_upper`

- **`remotecontrol_reactive_power`**: Reaktivn√≠ v√Ωkon (doporuƒçeno ponechat 0)

### ƒåasov√© parametry
- **`remotecontrol_duration`**: Doba platnosti p≈ô√≠kazu (sekundy, v√Ωchoz√≠ 20s)
- **`remotecontrol_autorepeat_duration`**: Doba automatick√©ho opakov√°n√≠ (sekundy, 0 = vypnuto)

### Limity
- **`remotecontrol_import_limit`**: Maxim√°ln√≠ import ze s√≠tƒõ (W)
- **`remotecontrol_set_type`**: Typ operace (`"Set"` nebo `"Update"`)

## Principy fungov√°n√≠

### Grid Control vs Battery Control
```
Grid Control (remotecontrol_active_power = 2000W):
- C√≠l: Import 2000W ze s√≠tƒõ
- Baterie se p≈ôizp≈Øsob√≠ podle dostupnosti FVE a dom√°c√≠ spot≈ôeby

Battery Control (remotecontrol_active_power = 2000W):
- C√≠l: Nab√≠jen√≠ baterie 2000W
- S√≠≈• se p≈ôizp≈Øsob√≠ podle dostupnosti FVE a dom√°c√≠ spot≈ôeby
```

### Aktivn√≠ v√Ωkon (Active Power)
Solax definuje aktivn√≠ v√Ωkon jako:
```
Active Power = Grid_Import - House_Load
Active Power = Battery_Charge - PV_Power
```

## Monitorovac√≠ senzory

### Stav RemoteControl
- **`modbus_power_control`**: Aktu√°ln√≠ stav modbus power control
- **`target_finish_flag`**: P≈ô√≠znak dokonƒçen√≠ c√≠le
- **`remotecontrol_autorepeat_remaining`**: Zb√Ωvaj√≠c√≠ ƒças autoreopakov√°n√≠

### V√Ωkonov√© hodnoty
- **`active_power_target`**: C√≠lov√Ω aktivn√≠ v√Ωkon
- **`reactive_power_target`**: C√≠lov√Ω reaktivn√≠ v√Ωkon
- **`active_power_real`**: Skuteƒçn√Ω aktivn√≠ v√Ωkon
- **`reactive_power_real`**: Skuteƒçn√Ω reaktivn√≠ v√Ωkon

### Limity v√Ωkonu
- **`active_power_upper`**: Horn√≠ limit aktivn√≠ho v√Ωkonu
- **`active_power_lower`**: Doln√≠ limit aktivn√≠ho v√Ωkonu
- **`reactive_power_upper`**: Horn√≠ limit reaktivn√≠ho v√Ωkonu
- **`reactive_power_lower`**: Doln√≠ limit reaktivn√≠ho v√Ωkonu

## P≈ô√≠klad pou≈æit√≠

### Z√°kladn√≠ nab√≠jen√≠ baterie
```yaml
# Nastaven√≠ parametr≈Ø
- service: select.select_option
  data:
    option: "Enabled Battery Control"
  target:
    entity_id: select.solax_remotecontrol_power_control

- service: number.set_value
  data:
    value: 3000  # 3kW nab√≠jen√≠
  target:
    entity_id: number.solax_remotecontrol_active_power

- service: number.set_value
  data:
    value: 3600  # 1 hodina autorepeat
  target:
    entity_id: number.solax_remotecontrol_autorepeat_duration

# Aktivace
- service: button.press
  target:
    entity_id: button.solax_remotecontrol_trigger
```

### ≈ò√≠zen√≠ importu ze s√≠tƒõ
```yaml
# Grid Control - p≈ôesn√Ω import 1kW ze s√≠tƒõ
- service: select.select_option
  data:
    option: "Enabled Grid Control"
  target:
    entity_id: select.solax_remotecontrol_power_control

- service: number.set_value
  data:
    value: 1000  # 1kW import
  target:
    entity_id: number.solax_remotecontrol_active_power

- service: number.set_value
  data:
    value: 10000  # Vysok√Ω import limit
  target:
    entity_id: number.solax_remotecontrol_import_limit

- service: button.press
  target:
    entity_id: button.solax_remotecontrol_trigger
```

## Hodnocen√≠ u≈æiteƒçnosti pro PowerStreamPlan

### ‚úÖ V√Ωhody pro n√°≈° syst√©m

1. **P≈ôesn√© ≈ô√≠zen√≠ v√Ωkonu**
   - Aktu√°ln√≠ syst√©m pou≈æ√≠v√° pouze re≈æimy (Manual Charge/Discharge, Feedin Priority)
   - RemoteControl umo≈æ≈àuje p≈ôesn√© nastaven√≠ v√Ωkonu (nap≈ô. 2.5kW m√≠sto jen "nab√≠jen√≠")
   - L√©pe odpov√≠d√° v√Ωstup≈Øm MPC optimaliz√°toru

2. **Vysok√° frekvence aktualizac√≠**
   - MPC bƒõ≈æ√≠ ka≈æd√Ωch 5-15 minut
   - RemoteControl m≈Ø≈æe b√Ωt aktualizov√°n bez omezen√≠
   - Autorepeat zajist√≠ kontinuitu bez z√°sahu automatizace

3. **Jemnƒõj≈°√≠ kontrola**
   - Grid Control: P≈ôesn√© ≈ô√≠zen√≠ importu/exportu
   - Battery Control: P≈ôesn√© ≈ô√≠zen√≠ nab√≠jen√≠/vyb√≠jen√≠
   - Import/Export limity pro peak shaving

4. **Lep≈°√≠ integrace s MPC**
   - MPC optimaliz√°tor poƒç√≠t√° p≈ôesn√© v√Ωkony (b_charge, b_discharge, g_buy, g_sell)
   - RemoteControl m≈Ø≈æe tyto hodnoty p≈ô√≠mo pou≈æ√≠t
   - Eliminuje diskr√©tn√≠ p≈ôep√≠n√°n√≠ mezi re≈æimy

### ‚ö†Ô∏è Nev√Ωhody a omezen√≠

1. **Pouze Gen4 st≈ô√≠daƒçe**
   - Aktu√°lnƒõ podporuje jen Solax Gen4
   - Gen3 podpora "bude dokumentov√°na pozdƒõji"

2. **Asymetrick√° distribuce v√Ωkonu**
   - **KRITICK√â**: RemoteControl rozdƒõluje v√Ωkon symetricky mezi 3 f√°ze (v√Ωkon/3 na ka≈ædou f√°zi)
   - **Probl√©m**: P≈ôi asymetrick√©m zat√≠≈æen√≠ dom√°cnosti m≈Ø≈æe doj√≠t k neoƒçek√°van√©mu chov√°n√≠
   - **Dopad**: M≈Ø≈æe zp≈Øsobit nevyv√°≈æen√© f√°ze a probl√©my s bilanc√≠ v√Ωkonu
   - **≈òe≈°en√≠**: Nutno zohlednit p≈ôi v√Ωpoƒçtech MPC optimaliz√°toru

   **Anal√Ωza dopadu pro ƒåR:**
   - **√öƒçtov√°n√≠ v ƒåR**: **F√ÅZOVƒö** - od roku 2011 se v ƒåR mƒõ≈ô√≠ elekt≈ôina po f√°z√≠ch (vyhl√°≈°ka 359/2020):
     - **D≈Øsledek**: Energie dodan√° do s√≠tƒõ na jedn√© f√°zi je pova≈æov√°na za p≈ôetok, energie odebran√° ze s√≠tƒõ na jin√© f√°zi za standardn√≠ odbƒõr
     - **P≈ô√≠klad**: Pokud z L1 odeberete 3kW a na L2 dod√°te 3kW, v Polsku/Nƒõmecku jste na nule, v ƒåR plat√≠te distribuƒçn√≠ poplatky za 3kW odbƒõr
     - **Evropsk√Ω kontext**: ƒåR je jednou z posledn√≠ch zem√≠ EU s t√≠mto syst√©mem (podobnƒõ Portugalsko, ƒç√°st Slovenska)
   - **Novela Lex OZE II (2024)**: Zaveden√≠ principu "sd√≠l√≠m s√°m sobƒõ":
     - **V√Ωhoda**: Energie dodan√° do s√≠tƒõ z jedn√© f√°ze se zapoƒç√≠t√° do spot≈ôeby i na ostatn√≠ch f√°z√≠ch
     - **Omezen√≠**: √öspora jen na cenƒõ silov√© elekt≈ôiny (40-50%), regulovanou slo≈æku si mus√≠te fakturovat sami sobƒõ
     - **St√°le plat√≠**: F√°zov√© mƒõ≈ôen√≠ podle vyhl√°≈°ky 359/2020, souƒçtov√© hodnocen√≠ jen pro sd√≠len√≠
   - **Re√°ln√Ω dopad**: Asymetrie m√° v ƒåR v≈ædy finanƒçn√≠ dopad kv≈Øli f√°zov√©mu mƒõ≈ôen√≠:
     - Neoptim√°ln√≠ vyu≈æit√≠ FVE p≈ôi asymetrick√©m zat√≠≈æen√≠
     - Mo≈æn√© probl√©my s ji≈°tƒõn√≠m jednotliv√Ωch f√°z√≠
     - Zv√Ω≈°en√© ztr√°ty v s√≠ti p≈ôi nevyv√°≈æen√©m zat√≠≈æen√≠
   - **Praktick√© sc√©n√°≈ôe**:
     - **Vysok√© zat√≠≈æen√≠ L1** (nap≈ô. indukƒçn√≠ deska): RemoteControl d√° 1/3 v√Ωkonu na L1 ‚Üí nedostateƒçn√©
     - **N√≠zk√© zat√≠≈æen√≠ L2,L3**: RemoteControl d√° zbyteƒçnƒõ v√Ωkon i na tyto f√°ze
     - **V√Ωsledek**: Neoptim√°ln√≠ distribuce m≈Ø≈æe v√©st k importu na L1 a exportu na L2/L3 souƒçasnƒõ

3. **Slo≈æitost implementace**
   - V√≠ce parametr≈Ø k nastaven√≠
   - Nutnost pochopen√≠ Active Power konceptu
   - Autorepeat management

4. **Z√°vislost na Home Assistant integraci**
   - Pot≈ôeba nejnovƒõj≈°√≠ verze homeassistant-solax-modbus
   - Mo≈æn√© probl√©my s kompatibilitou

### üîß Doporuƒçen√≠ pro implementaci

1. **Postupn√° migrace**
   - Zachovat souƒçasn√Ω syst√©m jako fallback
   - P≈ôidat RemoteControl jako volitelnou funkci
   - Testovat stabilitu p≈ôed pln√Ωm nasazen√≠m

2. **Konfigurace**
   - P≈ôidat mo≈ænost v√Ωbƒõru ≈ô√≠d√≠c√≠ho re≈æimu (Current/RemoteControl)
   - Autodetekce podpory RemoteControl
   - Konfigurovateln√© autorepeat interval

3. **≈òe≈°en√≠ asymetrie f√°z√≠**
   - **Monitorov√°n√≠**: Sledovat v√Ωkon jednotliv√Ωch f√°z√≠
   - **Kompenzace**: Zohlednit symetrick√© rozdƒõlen√≠ ve v√Ωpoƒçtech
   - **Limity**: Nastavit konzervativnƒõj≈°√≠ limity pro vyhnut√≠ se p≈ôet√≠≈æen√≠ f√°z√≠
   - **Fallback**: P≈ôi detekci probl√©m≈Ø s asymetri√≠ p≈ôepnout na standardn√≠ re≈æimy

   **Specifika pro ƒåR:**
   - **Monitorov√°n√≠ f√°z√≠**: Vyu≈æ√≠t senzory `sensor.solax_phase_a_power`, `sensor.solax_phase_b_power`, `sensor.solax_phase_c_power`
   - **Detekce asymetrie**: V√Ωpoƒçet rozd√≠lu mezi nejvy≈°≈°√≠ a nejni≈æ≈°√≠ f√°z√≠
   - **Pr√°h asymetrie**: Pokud rozd√≠l > 1kW, preferovat standardn√≠ re≈æimy (minimalizace distribuƒçn√≠ch poplatk≈Ø)
   - **Optimalizace**: RemoteControl pou≈æ√≠vat pouze p≈ôi symetrick√©m zat√≠≈æen√≠ (rozd√≠l f√°z√≠ < 1kW)
   - **ƒåasov√© okna**: Vyu≈æ√≠t p≈ôi noƒçn√≠m obdob√≠ (22:00-06:00) kdy je zat√≠≈æen√≠ obvykle symetriƒçtƒõj≈°√≠

4. **Vylep≈°en√≠ actions.py**
   ```python
   def use_remotecontrol(sol, slot_index):
       # P≈ôevod MPC v√Ωstup≈Ø na RemoteControl s ohledem na asymetrii
       target_power = 0
       
       if sol["outputs"]["b_charge"][slot_index] > 0.1:
           target_power = sol["outputs"]["b_charge"][slot_index] * 1000
           mode = "Enabled Battery Control"
       elif sol["outputs"]["b_discharge"][slot_index] > 0.1:
           target_power = -sol["outputs"]["b_discharge"][slot_index] * 1000
           mode = "Enabled Battery Control"
       
       # POZOR: RemoteControl rozdƒõluje v√Ωkon/3 na ka≈ædou f√°zi
       # P≈ôi asymetrick√©m zat√≠≈æen√≠ m≈Ø≈æe doj√≠t k probl√©m≈Øm
       max_phase_power = target_power / 3
       
       return {
           "mode": mode,
           "active_power": target_power,
           "duration": 900,  # 15 minut
           "note": f"V√Ωkon {max_phase_power:.0f}W na f√°zi"
       }
   ```

   **Roz≈°√≠≈ôen√Ω k√≥d pro ƒåR:**
   ```python
   def use_remotecontrol_cz(sol, slot_index, phase_powers):
       """
       RemoteControl s kontrolou asymetrie f√°z√≠ pro ƒçesk√© podm√≠nky
       
       Args:
           sol: MPC ≈ôe≈°en√≠
           slot_index: Index ƒçasov√©ho slotu
           phase_powers: [L1_power, L2_power, L3_power] - aktu√°ln√≠ v√Ωkony f√°z√≠
       """
       # Kontrola asymetrie f√°z√≠
       max_phase = max(phase_powers)
       min_phase = min(phase_powers)
       asymmetry = max_phase - min_phase
       
       # Pokud je asymetrie > 1kW, nepou≈æ√≠vat RemoteControl
       if asymmetry > 1000:  # 1kW pr√°h pro minimalizaci distribuƒçn√≠ch poplatk≈Ø
           return {"use_remotecontrol": False, "reason": "Asymetrie zp≈Øsob√≠ vy≈°≈°√≠ distribuƒçn√≠ poplatky"}
       
       # V√Ωpoƒçet c√≠lov√©ho v√Ωkonu
       target_power = 0
       if sol["outputs"]["b_charge"][slot_index] > 0.1:
           target_power = sol["outputs"]["b_charge"][slot_index] * 1000
           mode = "Enabled Battery Control"
       elif sol["outputs"]["b_discharge"][slot_index] > 0.1:
           target_power = -sol["outputs"]["b_discharge"][slot_index] * 1000
           mode = "Enabled Battery Control"
       
       # Kontrola, zda nedojde k p≈ôet√≠≈æen√≠ f√°ze
       power_per_phase = target_power / 3
       max_resulting_phase = max(phase_powers) + power_per_phase
       
       if max_resulting_phase > 7000:  # 7kW limit na f√°zi (30A jistiƒç)
           return {"use_remotecontrol": False, "reason": "Riziko p≈ôet√≠≈æen√≠ f√°ze"}
       
       return {
           "use_remotecontrol": True,
           "mode": mode,
           "active_power": target_power,
           "duration": 900,
           "asymmetry_kw": asymmetry / 1000,
           "power_per_phase": power_per_phase
       }
   ```

## Z√°vƒõr

RemoteControl je u≈æiteƒçn√° funkce pro PowerStreamPlan s omezen√≠mi, kter√° jsou v ƒçesk√Ωch podm√≠nk√°ch zvladateln√°. Hlavn√≠ v√Ωhody:

- **P≈ôesnost**: M√≠sto diskr√©tn√≠ch re≈æim≈Ø p≈ôesn√© ≈ô√≠zen√≠ v√Ωkonu
- **Flexibilita**: ƒåastƒõj≈°√≠ aktualizace bez omezen√≠ EEPROM
- **Integrace**: Lep≈°√≠ vyu≈æit√≠ MPC optimaliz√°toru v√Ωstup≈Ø

**Kritick√© omezen√≠**: Symetrick√© rozdƒõlen√≠ v√Ωkonu mezi f√°ze (v√Ωkon/3) m≈Ø≈æe zp≈Øsobit neoptim√°ln√≠ chov√°n√≠ p≈ôi asymetrick√©m zat√≠≈æen√≠.

### Hodnocen√≠ pro ƒçesk√© podm√≠nky:

**‚úÖ Pozitivn√≠ aspekty:**
- Novela Lex OZE II zm√≠r≈àuje probl√©m f√°zov√©ho mƒõ≈ôen√≠ principem "sd√≠l√≠m s√°m sobƒõ"
- Asymetrie se projev√≠ "jen" ve vy≈°≈°√≠ch distribuƒçn√≠ch poplatc√≠ch, ne v celkov√Ωch n√°kladech
- √öspora 40-50% n√°klad≈Ø na elekt≈ôinu p≈ôi asymetrii d√≠ky sd√≠len√≠

**‚ö†Ô∏è Rizika:**
- **F√°zov√© mƒõ≈ôen√≠**: V≈ædy vy≈°≈°√≠ distribuƒçn√≠ poplatky p≈ôi asymetrii (od roku 2011)
- **Finanƒçn√≠ dopad**: P≈ôi extr√©mn√≠ asymetrii (RemoteControl = v√Ωkon/3) plat√≠te distribuƒçn√≠ poplatky za "zbyteƒçn√Ω" odbƒõr
- **P≈ô√≠klad**: P≈ôi 6kW nab√≠jen√≠ baterie RemoteControl d√° 2kW na ka≈ædou f√°zi, ale pokud L1 pot≈ôebuje 5kW, budete platit distribuƒçn√≠ poplatky za 3kW odbƒõr ze s√≠tƒõ na L1
- Mo≈æn√© p≈ôet√≠≈æen√≠ f√°ze p≈ôi kombinaci s asymetrick√Ωm zat√≠≈æen√≠m
- Neoptim√°ln√≠ vyu≈æit√≠ FVE p≈ôi koncentrovan√©m zat√≠≈æen√≠ na jednu f√°zi
- Nutnost monitorov√°n√≠ f√°z√≠ pro bezpeƒçn√© pou≈æit√≠

**üéØ Doporuƒçen√≠:**
- **Potvrzen√Ω finanƒçn√≠ dopad**: Asymetrie zvy≈°uje distribuƒçn√≠ poplatky (f√°zov√© mƒõ≈ôen√≠ od 2011)
- **Priorita: st≈ôedn√≠** - v√Ωhody RemoteControl vs. vy≈°≈°√≠ distribuƒçn√≠ poplatky p≈ôi asymetrii
- **Implementovat s inteligentn√≠ logikou**: Pou≈æ√≠t pouze p≈ôi asymetrii < 1kW pro minimalizaci dodateƒçn√Ωch n√°klad≈Ø
- **Monitorov√°n√≠ f√°z√≠**: Sledovat nejen bezpeƒçnost, ale i ekonomick√Ω dopad asymetrie
- **ƒåasov√© okna**: Preferovat noƒçn√≠ hodiny (22:00-06:00) kdy je zat√≠≈æen√≠ symetriƒçtƒõj≈°√≠
- **Fallback**: P≈ôi detekci probl√©m≈Ø automaticky p≈ôepnout na standardn√≠ re≈æimy

**V√Ωsledek**: RemoteControl m√° potvrzen√Ω finanƒçn√≠ dopad kv≈Øz f√°zov√©mu mƒõ≈ôen√≠ v ƒåR, ale novela Lex OZE II (2024) zm√≠r≈àuje probl√©m. **Asymetrie zp≈Øsobuje vy≈°≈°√≠ distribuƒçn√≠ poplatky, ale ne dramatick√© n√°klady.**
