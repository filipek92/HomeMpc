{# ============================================================================
   ğŸ”‹ PlÃ¡n tokÅ¯ energiÃ­ a stav systÃ©mu â€“ pÅ™ehledovÃ¡ Å¡ablona pro Home Assistant
   UpravenÃ¡ pro novÃ© atributy sensor.powerplan_debug (Ceny v KÄ)
============================================================================ #}

{# --------------------- SbÄ›r dat --------------------- #}
{% set soc = states('sensor.solax_battery_capacity')|float(0) %}
{% set target_soc = states('sensor.powerplan_battery_target')|float(0) %}
{% set plan_pwr = states('sensor.powerplan_battery_power')|float(0) %}
{% set real_pwr = states('sensor.solax_battery_power_charge')|float(0) %}
{% set b_power = state_attr('sensor.powerplan_debug','b_power')|float(0) %}
{% set tuv_target_pct = state_attr('sensor.powerplan_debug','tuv_soc_target_pct')|float(0) %}

{% set temp_top = states('sensor.tepelnaakumulace_horn_senzor')|float(0) %}
{% set temp_mid = states('sensor.tepelnaakumulace_st_edn_senzor')|float(0) %}
{% set temp_bot = states('sensor.tepelnaakumulace_spodn_senzor')|float(0) %}
{% set tank_energy = states('sensor.tepelnaakumulace_energie_n_dr_e')|float(0) %}
{% set tank_soc = states('sensor.tepelnaakumulace_nabit_n_dr_e')|float(0) %}

{# --------------------- Barvy pro teplotu --------------------- #}
{% macro temp_icon(t) -%}
  {{- iif(t < 30, 'ğŸ”µ', iif(t < 45, 'ğŸŸ¡', 'ğŸ”´')) -}}
{%- endmacro %}

{# ============================================================================
   ğŸ§  PlÃ¡n vyuÅ¾itÃ­ energie
============================================================================ #}
## ğŸ§  PlÃ¡n vyuÅ¾itÃ­ energie (aktuÃ¡lnÃ­ slot)
ğŸ”‹ ReÅ¾im: {{ states('sensor.powerplan_charger_use_mode') }}{% if is_state('sensor.powerplan_charger_use_mode','Manual Mode') %} â†’ aktivnÃ­ vybÃ­jenÃ­{% elif is_state('sensor.powerplan_charger_use_mode','Feedin Priority') %} â†’ pÅ™etoky z FVE{% elif is_state('sensor.powerplan_charger_use_mode','Back Up Mode') %} â†’ zÃ¡loÅ¾nÃ­ reÅ¾im{% endif %} â€¢ â™¨ï¸ {{ 'TUV' if is_state('sensor.powerplan_acumulation_on','True') else '~~TUV~~' }} â€¢ ğŸ”¥ {{ 'Max-heat' if is_state('sensor.powerplan_max_heat_on','True') else '~~Max-heat~~' }} â€¢ ğŸ¯ CÃ­l: {{ target_soc|round(1) }}% â€¢ âš¡ PlÃ¡n: {{ plan_pwr|round(0) }}W  
ğŸ”‹ b_power: {{ b_power|float(0)|round(2) }}kW â€¢ ğŸ“¥ b_charge: {{ state_attr('sensor.powerplan_debug','b_charge')|float(0)|round(2) }}kW â€¢ ğŸ“¤ b_discharge: {{ state_attr('sensor.powerplan_debug','b_discharge')|float(0)|round(2) }}kW  
ğŸ”Œ g_sell: {{ state_attr('sensor.powerplan_debug','g_sell')|float(0)|round(2) }}kW â€¢ ğŸ“¥ g_buy: {{ state_attr('sensor.powerplan_debug','g_buy')|float(0)|round(2) }}kW  
ğŸ’² NÃ¡kup: {{ state_attr('sensor.powerplan_debug','buy_cost')|float(0)|round(2) }}KÄ â€¢ ğŸ’° Prodej: {{ state_attr('sensor.powerplan_debug','sell_income')|float(0)|round(2) }}KÄ â€¢ ğŸ§¾ Bilance: {{ state_attr('sensor.powerplan_debug','net_step_cost')|float(0)|round(2) }}KÄ

---

## âš¡ ReÃ¡lnÃ½ stav mÄ›niÄe a baterie
ğŸ§© MÄ›niÄ: {{ states('sensor.solax_run_mode')|default('â€“') }} â€¢ VÃ½kon: {{ states('sensor.solax_inverter_power')|default('â€“') }}W â€¢ Teplota: {{ states('sensor.solax_inverter_temperature')|default('â€“') }}Â°C  
ğŸ”‹ SOC: {{ soc|round(1) }}% â€¢ VÃ½kon: {{ real_pwr|round(0) }}W â€¢ NapÄ›tÃ­: {{ states('sensor.solax_battery_voltage_charge')|default('â€“') }}V â€¢ Teplota: {{ states('sensor.solax_battery_temperature')|default('â€“') }}Â°C  
â˜€ï¸ PV: {{ states('sensor.solax_pv_power_total')|default('â€“') }}W â€¢ ğŸ  DÅ¯m: {{ states('sensor.solax_house_load')|default('â€“') }}W â€¢ ğŸ“¤ Export: {{ states('sensor.solax_grid_export')|default('â€“') }}W â€¢ ğŸ“¥ Import: {{ states('sensor.solax_grid_import')|default('â€“') }}W

---

## ğŸ›¢ï¸ AkumulaÄnÃ­ nÃ¡drÅ¾
ğŸ”¼ {{ temp_icon(temp_top) }} {{ temp_top|round(1) }}Â°C â€¢ ğŸ” {{ temp_icon(temp_mid) }} {{ temp_mid|round(1) }}Â°C â€¢ ğŸ”½ {{ temp_icon(temp_bot) }} {{ temp_bot|round(1) }}Â°C â€¢ ğŸ”‹ {{ tank_energy|round(1) }}kWh â€¢ SOC: {{ tank_soc|round(1) }}%  
ğŸ’§ H_SOC: {{ state_attr('sensor.powerplan_debug','h_soc_percent')|float(0)|round(1) }}% ({{ state_attr('sensor.powerplan_debug','h_soc')|float(0)|round(2) }}kWh) â€¢ H_in: {{ state_attr('sensor.powerplan_debug','h_in')|float(0)|round(2) }}kW â€¢ H_out: {{ state_attr('sensor.powerplan_debug','h_out')|float(0)|round(2) }}kW

---

## âš™ï¸ Finance & vÃ½kon
ğŸ“Š Dobito: {{ state_attr('sensor.powerplan_debug','total_charged')|float(0)|round(2) }}kWh â€¢ Vybito: {{ state_attr('sensor.powerplan_debug','total_discharged')|float(0)|round(2) }}kWh  
ğŸ’² NÃ¡klady: {{ state_attr('sensor.powerplan_debug','total_buy_cost')|float(0)|round(2) }}KÄ â€¢ ğŸ’° VÃ½nosy: {{ state_attr('sensor.powerplan_debug','total_sell_income')|float(0)|round(2) }}KÄ â€¢ ğŸ§¾ ÄŒistÃ¡ bilance: {{ state_attr('sensor.powerplan_debug','net_bilance')|float(0)|round(2) }}KÄ  
ğŸ”¥ Boiler: {{ state_attr('sensor.powerplan_debug','total_final_boiler_value')|float(0)|round(2) }}KÄ â€¢ â˜€ï¸ NevyuÅ¾ito PV: {{ state_attr('sensor.powerplan_debug','total_fve_unused')|float(0)|round(2) }}kWh  
ğŸ“ˆ Pen_batt: {{ state_attr('sensor.powerplan_debug','total_battery_penalty')|float(0)|round(2) }}KÄ â€¢ Pen_under: {{ state_attr('sensor.powerplan_debug','total_battery_under_penalty')|float(0)|round(2) }}KÄ â€¢ Pen_PV: {{ state_attr('sensor.powerplan_debug','total_fve_unused_penalty')|float(0)|round(2) }}KÄ  
ğŸ“ˆ PriceAbove: {{ state_attr('sensor.powerplan_debug','total_bat_price_above')|float(0)|round(2) }} â€¢ PriceBelow: {{ state_attr('sensor.powerplan_debug','total_bat_price_below')|float(0)|round(2) }} â€¢ Obj: {{ state_attr('sensor.powerplan_debug','objective_value')|float(0)|round(2) }}KÄ?

---

{# ============================================================================
   âš ï¸ VarovÃ¡nÃ­ â€“ soulady a nesoulesy
============================================================================ #}
{% set warn_msgs = [] %}
{% if soc - target_soc > 5 and is_state('sensor.powerplan_charger_use_mode','Manual Mode') %}
  {% do warn_msgs.append('ğŸ”‹ SOC ' ~ soc|round(1) ~ '% (> cÃ­l), ale stÃ¡le se vybÃ­jÃ­') %}
{% endif %}
{% if target_soc - soc > 5 and is_state('sensor.powerplan_charger_use_mode','Back Up Mode') and real_pwr < 100 %}
  {% do warn_msgs.append('ğŸ”‹ SOC ' ~ soc|round(1) ~ '% (< cÃ­l), ale nenabÃ­jÃ­ se (' ~ real_pwr ~ ' W)') %}
{% endif %}
{% if plan_pwr < -100 and real_pwr > -100 %}
  {% do warn_msgs.append('ğŸ“¤ PlÃ¡nuje se vybÃ­jenÃ­ ' ~ plan_pwr|round(0) ~ ' W, ale baterie nevybÃ­jÃ­') %}
{% endif %}
{% if plan_pwr > 100 and real_pwr < 100 %}
  {% do warn_msgs.append('ğŸ“¥ PlÃ¡nuje se nabÃ­jenÃ­ ' ~ plan_pwr|round(0) ~ ' W, ale baterie nenabÃ­jÃ­') %}
{% endif %}
{% if not is_state('sensor.solax_run_mode','Normal Mode') %}
  {% do warn_msgs.append('ğŸ§© MÄ›niÄ nenÃ­ v reÅ¾imu Normal Mode') %}
{% endif %}
{% if is_state('sensor.powerplan_acumulation_on','True') and is_state('switch.tepelnaakumulace_povolen_horn_akumulace','off') and is_state('switch.tepelnaakumulace_povolen_spodn_akumulace','off') %}
  {% do warn_msgs.append('â™¨ï¸ Power plan poÅ¾aduje TUV, ale spirÃ¡ly jsou vypnutÃ©') %}
{% endif %}
{% if is_state('sensor.powerplan_max_heat_on','True') and is_state('switch.tepelnaakumulace_maxim_ln_oh_ev_ze_s_t','off') %}
  {% do warn_msgs.append('ğŸ”¥ Max-heat je poÅ¾adovÃ¡n, ale vypnutÃ½') %}
{% endif %}
{% if is_state('sensor.powerplan_acumulation_on','True') and tank_soc < tuv_target_pct - 10 %}
  {% do warn_msgs.append('â™¨ï¸ NÃ¡drÅ¾ mÃ¡ nabitÃ­ jen ' ~ tank_soc|round(1) ~ '%, cÃ­l je ' ~ tuv_target_pct|round(1) ~ '%') %}
{% endif %}
{% if is_state('sensor.powerplan_acumulation_on','True') and temp_top < 45 %}
  {% do warn_msgs.append('ğŸŒ¡ï¸ HornÃ­ ÄÃ¡st nÃ¡drÅ¾e mÃ¡ jen ' ~ temp_top ~ ' Â°C') %}
{% endif %}
{% if is_state('sensor.powerplan_acumulation_on','True') and temp_bot < 30 %}
  {% do warn_msgs.append('ğŸŒ¡ï¸ SpodnÃ­ ÄÃ¡st nÃ¡drÅ¾e je jen ' ~ temp_bot ~ ' Â°C') %}
{% endif %}
{% if is_state('sensor.powerplan_acumulation_on','True') and plan_pwr > 500 and real_pwr < 100 %}
  {% do warn_msgs.append('ğŸ”¥ PoÅ¾aduje se ohÅ™ev, ale vÃ½kon spirÃ¡ly je nÃ­zkÃ½ (' ~ real_pwr ~ ' W)') %}
{% endif %}
{% if states('sensor.solax_battery_temperature')|float > 50 %}
  {% do warn_msgs.append('âš ï¸ VysokÃ¡ teplota baterie: ' ~ states('sensor.solax_battery_temperature') ~ ' Â°C') %}
{% endif %}

{% if warn_msgs | length > 0 %}
## âš ï¸ VarovÃ¡nÃ­
{% for msg in warn_msgs %}- {{ msg }} {% endfor %}
{% else %}
âœ… VÅ¡e v poÅ™Ã¡dku â€“ plÃ¡n a realita jsou v souladu.
{% endif %}
