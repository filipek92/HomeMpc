views:
  - type: sections
    icon: mdi:trending-up
    cards: []
    title: PowerStreamPlan
    sections:
      # === PÅ˜EHLED PLÃNU ===
      - type: grid
        title: ğŸ“Š AktuÃ¡lnÃ­ plÃ¡n
        cards:
          - type: entities
            entities:
              - entity: sensor.powerplan_charger_use_mode
                name: ReÅ¾im mÄ›niÄe
                icon: mdi:transmission-tower-export
              - entity: sensor.powerplan_battery_target_soc
                name: CÃ­lovÃ½ SOC baterie
                icon: mdi:battery
              - entity: sensor.powerplan_battery_discharge_power
                name: PlÃ¡novanÃ½ vÃ½kon baterie
                icon: mdi:battery-arrow-down
              - entity: sensor.powerplan_reserve_power_charging
                name: RezervovanÃ½ vÃ½kon
                icon: mdi:battery-arrow-up
              - entity: sensor.powerplan_minimum_battery_soc
                name: MinimÃ¡lnÃ­ SOC
                icon: mdi:battery-low
            state_color: true
            show_header_toggle: false
          - type: entities
            entities:
              - entity: sensor.powerplan_upper_accumulation_on
                name: HornÃ­ akumulace
                icon: mdi:water-pump
              - entity: sensor.powerplan_lower_accumulation_on
                name: SpodnÃ­ akumulace
                icon: mdi:water-pump
              - entity: sensor.powerplan_max_heat_on
                name: MaximÃ¡lnÃ­ ohÅ™ev
                icon: mdi:fire
              - entity: sensor.powerplan_forced_heating_block
                name: BlokovÃ¡nÃ­ ohÅ™evu
                icon: mdi:block-helper
            state_color: true
            show_header_toggle: false
          - type: button
            name: OtevÅ™Ã­t PowerStreamPlan
            icon: mdi:chart-areaspline
            tap_action:
              action: navigate
              navigation_path: /local_mpc_optimizer/ingress
            show_name: true
            show_icon: true

      # === STAV SYSTÃ‰MU ===
      - type: grid
        title: âš¡ Stav systÃ©mu
        cards:
          - type: entities
            entities:
              - entity: sensor.solax_battery_capacity
                name: SOC baterie
                icon: mdi:battery
              - entity: sensor.solax_battery_power_charge
                name: VÃ½kon baterie
                icon: mdi:battery-charging
              - entity: sensor.solax_battery_temperature
                name: Teplota baterie
                icon: mdi:thermometer
              - entity: sensor.solax_battery_voltage_charge
                name: NapÄ›tÃ­ baterie
                icon: mdi:lightning-bolt
            state_color: true
            show_header_toggle: false
            title: ğŸ”‹ Baterie
          - type: entities
            entities:
              - entity: sensor.solax_pv_power_total
                name: VÃ½kon FVE
                icon: mdi:solar-power
              - entity: sensor.solax_house_load
                name: SpotÅ™eba domu
                icon: mdi:home-lightning-bolt
              - entity: sensor.solax_grid_export
                name: Export do sÃ­tÄ›
                icon: mdi:transmission-tower-export
              - entity: sensor.solax_grid_import
                name: Import ze sÃ­tÄ›
                icon: mdi:transmission-tower-import
            state_color: true
            show_header_toggle: false
            title: âš¡ Energie
          - type: entities
            entities:
              - entity: sensor.solax_run_mode
                name: ReÅ¾im mÄ›niÄe
                icon: mdi:cog
              - entity: sensor.solax_inverter_power
                name: VÃ½kon mÄ›niÄe
                icon: mdi:solar-power-variant
              - entity: sensor.solax_inverter_temperature
                name: Teplota mÄ›niÄe
                icon: mdi:thermometer
            state_color: true
            show_header_toggle: false
            title: ğŸ§© MÄ›niÄ

      # === AKUMULACE ===
      - type: grid
        title: ğŸ›¢ï¸ TepelnÃ¡ akumulace
        cards:
          - type: entities
            entities:
              - entity: sensor.tepelnaakumulace_horn_senzor
                name: HornÃ­ teplota
                icon: mdi:thermometer-high
              - entity: sensor.tepelnaakumulace_st_edn_senzor
                name: StÅ™ednÃ­ teplota
                icon: mdi:thermometer
              - entity: sensor.tepelnaakumulace_spodn_senzor
                name: SpodnÃ­ teplota
                icon: mdi:thermometer-low
              - entity: sensor.tepelnaakumulace_energie_n_dr_e
                name: Energie v nÃ¡drÅ¾i
                icon: mdi:fire
              - entity: sensor.tepelnaakumulace_nabit_n_dr_e
                name: SOC nÃ¡drÅ¾e
                icon: mdi:water-percent
            state_color: true
            show_header_toggle: false
            title: ğŸŒ¡ï¸ Teploty a stav
          - type: entities
            entities:
              - entity: switch.tepelnaakumulace_povolen_horn_akumulace
                name: HornÃ­ akumulace
                icon: mdi:water-pump
              - entity: switch.tepelnaakumulace_povolen_spodn_akumulace
                name: SpodnÃ­ akumulace
                icon: mdi:water-pump
              - entity: switch.tepelnaakumulace_maxim_ln_oh_ev_ze_s_t
                name: MaximÃ¡lnÃ­ ohÅ™ev
                icon: mdi:fire
              - entity: switch.tepelnaakumulace_blokov_n_nucen_ho_oh_evu
                name: BlokovÃ¡nÃ­ ohÅ™evu
                icon: mdi:block-helper
            state_color: true
            show_header_toggle: false
            title: ğŸ›ï¸ OvlÃ¡dÃ¡nÃ­
          - type: entities
            entities:
              - entity: select.solax_charger_use_mode
                name: ReÅ¾im mÄ›niÄe
                icon: mdi:cog
              - entity: automation.powerplan_rizeni_akumulace_a_rezimu_menice
                name: Automatizace
                icon: mdi:robot
                secondary_info: last-triggered
              - entity: counter.denni_eeprom_zapisy
                name: DennÃ­ EEPROM zÃ¡pisy
                icon: mdi:counter
            state_color: true
            show_header_toggle: false
            title: ğŸ¤– Automatizace

      # === STAV A MONITORING ===
      - type: grid
        title: ğŸ“ˆ Monitoring a diagnostika
        cards:
          - type: markdown
            content: |
              ## ğŸ§  AktuÃ¡lnÃ­ plÃ¡n

              {% set mode = states('sensor.powerplan_charger_use_mode') %}
              {% set upper_acum = is_state('sensor.powerplan_upper_accumulation_on', 'True') %}
              {% set lower_acum = is_state('sensor.powerplan_lower_accumulation_on', 'True') %}
              {% set max_heat = is_state('sensor.powerplan_max_heat_on', 'True') %}
              {% set target_soc = states('sensor.powerplan_battery_target_soc')|float(0) %}
              {% set discharge_power = states('sensor.powerplan_battery_discharge_power')|float(0) %}

              **ReÅ¾im mÄ›niÄe:** {{ mode }}
              {% if mode == 'Manual' %}ğŸ”§ RuÄnÃ­ Å™Ã­zenÃ­{% elif mode == 'Feedin Priority' %}ğŸ“¤ Prodej pÅ™ebytkÅ¯{% elif mode == 'Back Up Mode' %}ğŸ”‹ ZÃ¡loÅ¾nÃ­ reÅ¾im{% endif %}

              **Akumulace:**
              {% if upper_acum %}ğŸ”¼ HornÃ­ spirÃ¡la{% endif %}
              {% if lower_acum %}ğŸ”½ SpodnÃ­ spirÃ¡la{% endif %}
              {% if max_heat %}ğŸ”¥ MaximÃ¡lnÃ­ ohÅ™ev{% endif %}
              {% if not (upper_acum or lower_acum or max_heat) %}âŒ Vypnuto{% endif %}

              **Baterie:** CÃ­l {{ target_soc }}%
              {% if discharge_power > 0 %}âš¡ PlÃ¡novanÃ© vybÃ­jenÃ­ {{ discharge_power }}W{% endif %}

          - type: markdown
            content: |
              ## âš¡ AktuÃ¡lnÃ­ stav

              {% set soc = states('sensor.solax_battery_capacity')|float(0) %}
              {% set battery_power = states('sensor.solax_battery_power_charge')|float(0) %}
              {% set fve_power = states('sensor.solax_pv_power_total')|float(0) %}
              {% set house_load = states('sensor.solax_house_load')|float(0) %}
              {% set grid_export = states('sensor.solax_grid_export')|float(0) %}
              {% set grid_import = states('sensor.solax_grid_import')|float(0) %}

              **Baterie:** {{ soc }}% ({{ battery_power }}W)
              {% if battery_power > 50 %}ğŸ”‹ NabÃ­jÃ­ se{% elif battery_power < -50 %}âš¡ VybÃ­jÃ­ se{% else %}â¸ï¸ Standby{% endif %}

              **Energie:**
              - â˜€ï¸ FVE: {{ fve_power }}W
              - ğŸ  SpotÅ™eba: {{ house_load }}W
              {% if grid_export > 10 %}- ğŸ“¤ Export: {{ grid_export }}W{% endif %}
              {% if grid_import > 10 %}- ğŸ“¥ Import: {{ grid_import }}W{% endif %}

              {% if grid_export > 100 %}
              ğŸ’° **ProdÃ¡vÃ¡ se do sÃ­tÄ›**
              {% elif grid_import > 100 %}
              ğŸ’¸ **Nakupuje se ze sÃ­tÄ›**
              {% else %}
              âš–ï¸ **SystÃ©m v rovnovÃ¡ze**
              {% endif %}

          - type: markdown
            content: |
              ## ğŸ›¢ï¸ TepelnÃ¡ nÃ¡drÅ¾

              {% set temp_top = states('sensor.tepelnaakumulace_horn_senzor')|float(0) %}
              {% set temp_mid = states('sensor.tepelnaakumulace_st_edn_senzor')|float(0) %}
              {% set temp_bot = states('sensor.tepelnaakumulace_spodn_senzor')|float(0) %}
              {% set tank_energy = states('sensor.tepelnaakumulace_energie_n_dr_e')|float(0) %}
              {% set tank_soc = states('sensor.tepelnaakumulace_nabit_n_dr_e')|float(0) %}

              **Teploty:**
              - ğŸ”¼ HornÃ­: {{ temp_top | round(1) }}Â°C {% if temp_top > 60 %}ğŸ”¥{% elif temp_top > 45 %}ğŸŸ¡{% else %}ğŸ”µ{% endif %}
              - ğŸ” StÅ™ednÃ­: {{ temp_mid | round(1) }}Â°C {% if temp_mid > 60 %}ğŸ”¥{% elif temp_mid > 45 %}ğŸŸ¡{% else %}ğŸ”µ{% endif %}
              - ğŸ”½ SpodnÃ­: {{ temp_bot | round(1) }}Â°C {% if temp_bot > 60 %}ğŸ”¥{% elif temp_bot > 45 %}ğŸŸ¡{% else %}ğŸ”µ{% endif %}

              **Stav:** {{ tank_soc | round(1) }}% ({{ tank_energy | round(1)  }}kWh)
              {% if tank_soc > 80 %}ğŸ”¥ PlnÄ› ohÅ™Ã¡tÃ¡{% elif tank_soc > 50 %}ğŸŸ¡ StÅ™ednÄ› ohÅ™Ã¡tÃ¡{% else %}ğŸ”µ StudenÃ¡{% endif %}

      # === DIAGNOSTIKA ===
      - type: grid
        title: ğŸ” Diagnostika
        cards:
          - type: markdown
            content: |
              ## âš ï¸ Kontrola stavu

              {% set soc = states('sensor.solax_battery_capacity')|float(0) %}
              {% set target_soc = states('sensor.powerplan_battery_target_soc')|float(0) %}
              {% set mode = states('sensor.powerplan_charger_use_mode') %}
              {% set upper_acum = is_state('sensor.powerplan_upper_accumulation_on', 'True') %}
              {% set lower_acum = is_state('sensor.powerplan_lower_accumulation_on', 'True') %}
              {% set max_heat = is_state('sensor.powerplan_max_heat_on', 'True') %}
              {% set upper_switch = is_state('switch.tepelnaakumulace_povolen_horn_akumulace', 'on') %}
              {% set lower_switch = is_state('switch.tepelnaakumulace_povolen_spodn_akumulace', 'on') %}
              {% set max_heat_switch = is_state('switch.tepelnaakumulace_maxim_ln_oh_ev_ze_s_t', 'on') %}
              {% set temp_top = states('sensor.tepelnaakumulace_horn_senzor')|float(0) %}
              {% set battery_temp = states('sensor.solax_battery_temperature')|float(0) %}
              {% set run_mode = states('sensor.solax_run_mode') %}

              {% set eeprom_counter = states('counter.denni_eeprom_zapisy')|float(0) %}
              {% set warnings = [] %}
              {% if eeprom_counter > 10 %}
                {% set warnings = warnings + ['ğŸ›¡ï¸ EEPROM POJISTKA AKTIVNÃ! DennÃ­ zÃ¡pisy: ' + eeprom_counter|string + ' (limit 10)'] %}
              {% elif eeprom_counter > 7 %}
                {% set warnings = warnings + ['âš ï¸ EEPROM zÃ¡pisy blÃ­zko limitu: ' + eeprom_counter|string + '/10'] %}
              {% endif %}
              {% if (soc - target_soc)|abs > 10 %}
                {% set warnings = warnings + ['ğŸ”‹ SOC baterie se liÅ¡Ã­ od cÃ­le o ' + ((soc - target_soc)|abs)|string + '%'] %}
              {% endif %}
              {% if (upper_acum or lower_acum) and not (upper_switch or lower_switch) %}
                {% set warnings = warnings + ['â™¨ï¸ PlÃ¡n poÅ¾aduje akumulaci, ale spirÃ¡ly jsou vypnutÃ©'] %}
              {% endif %}
              {% if max_heat and not max_heat_switch %}
                {% set warnings = warnings + ['ğŸ”¥ PlÃ¡n poÅ¾aduje max ohÅ™ev, ale je vypnutÃ½'] %}
              {% endif %}
              {% if temp_top < 30 %}
                {% set warnings = warnings + ['ğŸŒ¡ï¸ Velmi nÃ­zkÃ¡ teplota v hornÃ­ ÄÃ¡sti nÃ¡drÅ¾e'] %}
              {% endif %}
              {% if battery_temp > 45 %}
                {% set warnings = warnings + ['âš ï¸ VysokÃ¡ teplota baterie: ' + battery_temp|string + 'Â°C'] %}
              {% endif %}
              {% if run_mode != 'Normal Mode' %}
                {% set warnings = warnings + ['ğŸ§© MÄ›niÄ nenÃ­ v normÃ¡lnÃ­m reÅ¾imu: ' + run_mode] %}
              {% endif %}

              {% if warnings %}
              {% for warning in warnings %}
              - {{ warning }}
              {% endfor %}
              {% else %}
              âœ… **VÅ¡e funguje sprÃ¡vnÄ›**
              {% endif %}

          - type: entities
            entities:
              - entity: sensor.powerplan_debug
                name: Debug informace
                icon: mdi:bug
            state_color: true
            show_header_toggle: false
            title: ğŸ› Debug

      # === WEBOVÃ APLIKACE ===
      - type: grid
        title: ğŸŒ PowerStreamPlan aplikace
        cards:
          - type: custom:addon-iframe-card
            url: local_mpc_optimizer/
            aspect_ratio: 50%
            grid_options:
              columns: full
              rows: 12
        column_span: 4
    max_columns: 4
