views:
  - type: sections
    icon: mdi:trending-up
    cards: []
    title: Pl√°n tok≈Ø energie
    sections:
      - type: grid
        cards:
          - type: entities
            entities:
              - entity: sensor.mpc_charger_use_mode
              - entity: sensor.mpc_acumulation_on
              - entity: sensor.mpc_max_heat_on
              - entity: sensor.mpc_battery_power
              - entity: sensor.solax_battery_capacity
              - entity: sensor.mpc_battery_target
              - entity: sensor.mpc_battery_discharge_current
              - entity: sensor.mpc_debug
                name: Akt√°ln√≠ slot
            title: MPC Pl√°n
            state_color: true
          - show_name: true
            show_icon: true
            type: button
            tap_action:
              action: navigate
              navigation_path: /local_mpc_optimizer/ingress
            name: Pl√°novaƒç
      - type: grid
        cards:
          - type: entities
            entities:
              - entity: switch.tepelnaakumulace_povolen_horn_akumulace
                name: Povolen√≠ horn√≠ akumulace
              - entity: switch.tepelnaakumulace_povolen_spodn_akumulace
                name: Povolen√≠ spodn√≠ akumulace
                secondary_info: none
              - entity: switch.tepelnaakumulace_blokov_n_nucen_ho_oh_evu
                name: ' Blokov√°n√≠ nucen√©ho oh≈ôevu'
              - entity: switch.tepelnaakumulace_maxim_ln_oh_ev_ze_s_t
                name: Maxim√°ln√≠ oh≈ôev ze s√≠tƒõ
              - entity: select.solax_charger_use_mode
              - entity: automation.mpc_rizeni_akumulace_a_rezimu_menice
                secondary_info: last-triggered
            state_color: true
            show_header_toggle: false
            title: Akumulace
          - type: entities
            entities:
              - entity: counter.denni_eeprom_zapisy
                name: Denn√≠ z√°pisy EEPROM
          - type: entities
            entities:
              - entity: sensor.tepelnaakumulace_energie_n_dr_e
              - entity: sensor.tepelnaakumulace_nabit_n_dr_e
              - entity: sensor.solax_battery_capacity
              - entity: sensor.mpc_battery_target
      - type: grid
        cards:
          - type: markdown
            content: >
              {#
              ============================================================================
                 üîã MPC a stav syst√©mu ‚Äì p≈ôehledov√° ≈°ablona pro Home Assistant
                 Upraven√° pro nov√© atributy sensor.mpc_debug (Ceny v Kƒç)
              ============================================================================
              #}


              {# --------------------- Sbƒõr dat --------------------- #}

              {% set soc = states('sensor.solax_battery_capacity')|float(0) %}

              {% set target_soc = states('sensor.mpc_battery_target')|float(0)
              %}

              {% set plan_pwr = states('sensor.mpc_battery_power')|float(0) %}

              {% set real_pwr =
              states('sensor.solax_battery_power_charge')|float(0) %}

              {% set b_power = state_attr('sensor.mpc_debug','b_power')|float(0)
              %}

              {% set tuv_target_pct =
              state_attr('sensor.mpc_debug','tuv_soc_target_pct')|float(0) %}


              {% set temp_top =
              states('sensor.tepelnaakumulace_horn_senzor')|float(0) %}

              {% set temp_mid =
              states('sensor.tepelnaakumulace_st_edn_senzor')|float(0) %}

              {% set temp_bot =
              states('sensor.tepelnaakumulace_spodn_senzor')|float(0) %}

              {% set tank_energy =
              states('sensor.tepelnaakumulace_energie_n_dr_e')|float(0) %}

              {% set tank_soc =
              states('sensor.tepelnaakumulace_nabit_n_dr_e')|float(0) %}


              {# --------------------- Barvy pro teplotu ---------------------
              #}

              {% macro temp_icon(t) -%}
                {{- iif(t < 30, 'üîµ', iif(t < 45, 'üü°', 'üî¥')) -}}
              {%- endmacro %}


              {#
              ============================================================================
                 üß† Pl√°n MPC
              ============================================================================
              #}

              ## üß† Pl√°n MPC (aktu√°ln√≠ slot)

              üîã Re≈æim: {{ states('sensor.mpc_charger_use_mode') }}{% if
              is_state('sensor.mpc_charger_use_mode','Manual Mode') %} ‚Üí aktivn√≠
              vyb√≠jen√≠{% elif is_state('sensor.mpc_charger_use_mode','Feedin
              Priority') %} ‚Üí p≈ôetoky z FVE{% elif
              is_state('sensor.mpc_charger_use_mode','Back Up Mode') %} ‚Üí
              z√°lo≈æn√≠ re≈æim{% endif %} ‚Ä¢ ‚ô®Ô∏è {{ 'TUV' if
              is_state('sensor.mpc_acumulation_on','True') else '~~TUV~~' }} ‚Ä¢
              üî• {{ 'Max-heat' if is_state('sensor.mpc_max_heat_on','True') else
              '~~Max-heat~~' }} ‚Ä¢ üéØ C√≠l: {{ target_soc|round(1) }}% ‚Ä¢ ‚ö° Pl√°n:
              {{ plan_pwr|round(0) }}W  

              üîã b_power: {{ b_power|float(0)|round(2) }}kW ‚Ä¢ üì• b_charge: {{
              state_attr('sensor.mpc_debug','b_charge')|float(0)|round(2) }}kW ‚Ä¢
              üì§ b_discharge: {{
              state_attr('sensor.mpc_debug','b_discharge')|float(0)|round(2)
              }}kW  

              üîå g_sell: {{
              state_attr('sensor.mpc_debug','g_sell')|float(0)|round(2) }}kW ‚Ä¢
              üì• g_buy: {{
              state_attr('sensor.mpc_debug','g_buy')|float(0)|round(2) }}kW  

              üí≤ N√°kup: {{
              state_attr('sensor.mpc_debug','buy_cost')|float(0)|round(2) }}Kƒç ‚Ä¢
              üí∞ Prodej: {{
              state_attr('sensor.mpc_debug','sell_income')|float(0)|round(2)
              }}Kƒç ‚Ä¢ üßæ Bilance: {{
              state_attr('sensor.mpc_debug','net_step_cost')|float(0)|round(2)
              }}Kƒç


              ---


              ## ‚ö° Re√°ln√Ω stav mƒõniƒçe a baterie

              üß© Mƒõniƒç: {{ states('sensor.solax_run_mode')|default('‚Äì') }} ‚Ä¢
              V√Ωkon: {{ states('sensor.solax_inverter_power')|default('‚Äì') }}W ‚Ä¢
              Teplota: {{
              states('sensor.solax_inverter_temperature')|default('‚Äì') }}¬∞C  

              üîã SOC: {{ soc|round(1) }}% ‚Ä¢ V√Ωkon: {{ real_pwr|round(0) }}W ‚Ä¢
              Napƒõt√≠: {{
              states('sensor.solax_battery_voltage_charge')|default('‚Äì') }}V ‚Ä¢
              Teplota: {{
              states('sensor.solax_battery_temperature')|default('‚Äì') }}¬∞C  

              ‚òÄÔ∏è PV: {{ states('sensor.solax_pv_power_total')|default('‚Äì') }}W ‚Ä¢
              üè† D≈Øm: {{ states('sensor.solax_house_load')|default('‚Äì') }}W ‚Ä¢ üì§
              Export: {{ states('sensor.solax_grid_export')|default('‚Äì') }}W ‚Ä¢
              üì• Import: {{ states('sensor.solax_grid_import')|default('‚Äì') }}W


              ---


              ## üõ¢Ô∏è Akumulaƒçn√≠ n√°dr≈æ

              üîº {{ temp_icon(temp_top) }} {{ temp_top|round(1) }}¬∞C ‚Ä¢ üîÅ {{
              temp_icon(temp_mid) }} {{ temp_mid|round(1) }}¬∞C ‚Ä¢ üîΩ {{
              temp_icon(temp_bot) }} {{ temp_bot|round(1) }}¬∞C ‚Ä¢ üîã {{
              tank_energy|round(1) }}kWh ‚Ä¢ SOC: {{ tank_soc|round(1) }}%  

              üíß H_SOC: {{
              state_attr('sensor.mpc_debug','h_soc_percent')|float(0)|round(1)
              }}% ({{ state_attr('sensor.mpc_debug','h_soc')|float(0)|round(2)
              }}kWh) ‚Ä¢ H_in: {{
              state_attr('sensor.mpc_debug','h_in')|float(0)|round(2) }}kW ‚Ä¢
              H_out: {{ state_attr('sensor.mpc_debug','h_out')|float(0)|round(2)
              }}kW


              ---


              ## ‚öôÔ∏è Finance & v√Ωkon

              üìä Dobito: {{
              state_attr('sensor.mpc_debug','total_charged')|float(0)|round(2)
              }}kWh ‚Ä¢ Vybito: {{
              state_attr('sensor.mpc_debug','total_discharged')|float(0)|round(2)
              }}kWh  

              üí≤ N√°klady: {{
              state_attr('sensor.mpc_debug','total_buy_cost')|float(0)|round(2)
              }}Kƒç ‚Ä¢ üí∞ V√Ωnosy: {{
              state_attr('sensor.mpc_debug','total_sell_income')|float(0)|round(2)
              }}Kƒç ‚Ä¢ üßæ ƒåist√° bilance: {{
              state_attr('sensor.mpc_debug','net_bilance')|float(0)|round(2)
              }}Kƒç  

              üî• Boiler: {{
              state_attr('sensor.mpc_debug','total_final_boiler_value')|float(0)|round(2)
              }}Kƒç ‚Ä¢ ‚òÄÔ∏è Nevyu≈æito PV: {{
              state_attr('sensor.mpc_debug','total_fve_unused')|float(0)|round(2)
              }}kWh  

              üìà Pen_batt: {{
              state_attr('sensor.mpc_debug','total_battery_penalty')|float(0)|round(2)
              }}Kƒç ‚Ä¢ Pen_under: {{
              state_attr('sensor.mpc_debug','total_battery_under_penalty')|float(0)|round(2)
              }}Kƒç ‚Ä¢ Pen_PV: {{
              state_attr('sensor.mpc_debug','total_fve_unused_penalty')|float(0)|round(2)
              }}Kƒç  

              üìà PriceAbove: {{
              state_attr('sensor.mpc_debug','total_bat_price_above')|float(0)|round(2)
              }} ‚Ä¢ PriceBelow: {{
              state_attr('sensor.mpc_debug','total_bat_price_below')|float(0)|round(2)
              }} ‚Ä¢ Obj: {{
              state_attr('sensor.mpc_debug','objective_value')|float(0)|round(2)
              }}Kƒç?


              ---


              {#
              ============================================================================
                 ‚ö†Ô∏è Varov√°n√≠ ‚Äì soulady a nesoulesy
              ============================================================================
              #}

              {% set warn_msgs = [] %}

              {% if soc - target_soc > 5 and
              is_state('sensor.mpc_charger_use_mode','Manual Mode') %}
                {% do warn_msgs.append('üîã SOC ' ~ soc|round(1) ~ '% (> c√≠l), ale st√°le se vyb√≠j√≠') %}
              {% endif %}

              {% if target_soc - soc > 5 and
              is_state('sensor.mpc_charger_use_mode','Back Up Mode') and
              real_pwr < 100 %}
                {% do warn_msgs.append('üîã SOC ' ~ soc|round(1) ~ '% (< c√≠l), ale nenab√≠j√≠ se (' ~ real_pwr ~ ' W)') %}
              {% endif %}

              {% if plan_pwr < -100 and real_pwr > -100 %}
                {% do warn_msgs.append('üì§ Pl√°nuje se vyb√≠jen√≠ ' ~ plan_pwr|round(0) ~ ' W, ale baterie nevyb√≠j√≠') %}
              {% endif %}

              {% if plan_pwr > 100 and real_pwr < 100 %}
                {% do warn_msgs.append('üì• Pl√°nuje se nab√≠jen√≠ ' ~ plan_pwr|round(0) ~ ' W, ale baterie nenab√≠j√≠') %}
              {% endif %}

              {% if not is_state('sensor.solax_run_mode','Normal Mode') %}
                {% do warn_msgs.append('üß© Mƒõniƒç nen√≠ v re≈æimu Normal Mode') %}
              {% endif %}

              {% if is_state('sensor.mpc_acumulation_on','True') and
              is_state('switch.tepelnaakumulace_povolen_horn_akumulace','off')
              and
              is_state('switch.tepelnaakumulace_povolen_spodn_akumulace','off')
              %}
                {% do warn_msgs.append('‚ô®Ô∏è MPC po≈æaduje TUV, ale spir√°ly jsou vypnut√©') %}
              {% endif %}

              {% if is_state('sensor.mpc_max_heat_on','True') and
              is_state('switch.tepelnaakumulace_maxim_ln_oh_ev_ze_s_t','off') %}
                {% do warn_msgs.append('üî• Max-heat je po≈æadov√°n, ale vypnut√Ω') %}
              {% endif %}

              {% if is_state('sensor.mpc_acumulation_on','True') and tank_soc <
              tuv_target_pct - 10 %}
                {% do warn_msgs.append('‚ô®Ô∏è N√°dr≈æ m√° nabit√≠ jen ' ~ tank_soc|round(1) ~ '%, c√≠l je ' ~ tuv_target_pct|round(1) ~ '%') %}
              {% endif %}

              {% if is_state('sensor.mpc_acumulation_on','True') and temp_top <
              45 %}
                {% do warn_msgs.append('üå°Ô∏è Horn√≠ ƒç√°st n√°dr≈æe m√° jen ' ~ temp_top ~ ' ¬∞C') %}
              {% endif %}

              {% if is_state('sensor.mpc_acumulation_on','True') and temp_bot <
              30 %}
                {% do warn_msgs.append('üå°Ô∏è Spodn√≠ ƒç√°st n√°dr≈æe je jen ' ~ temp_bot ~ ' ¬∞C') %}
              {% endif %}

              {% if is_state('sensor.mpc_acumulation_on','True') and plan_pwr >
              500 and real_pwr < 100 %}
                {% do warn_msgs.append('üî• Po≈æaduje se oh≈ôev, ale v√Ωkon spir√°ly je n√≠zk√Ω (' ~ real_pwr ~ ' W)') %}
              {% endif %}

              {% if states('sensor.solax_battery_temperature')|float > 50 %}
                {% do warn_msgs.append('‚ö†Ô∏è Vysok√° teplota baterie: ' ~ states('sensor.solax_battery_temperature') ~ ' ¬∞C') %}
              {% endif %}


              {% if warn_msgs | length > 0 %}

              ## ‚ö†Ô∏è Varov√°n√≠

              {% for msg in warn_msgs %}- {{ msg }} {% endfor %}

              {% else %}

              ‚úÖ V≈°e v po≈ô√°dku ‚Äì pl√°n a realita jsou v souladu.

              {% endif %}
            grid_options:
              columns: 24
              rows: auto
            text_only: true
          - type: markdown
            content: >
              {% set mode = states('sensor.mpc_charger_use_mode') %}

              {% set acum = is_state('sensor.mpc_acumulation_on', 'True') %}

              {% set maxh = is_state('sensor.mpc_max_heat_on', 'True') %}

              {% set soc = states('sensor.solax_battery_capacity')|float(0) %}

              {% set power =
              states('sensor.solax_battery_power_charge')|float(0) %}

              {% set fve = states('sensor.solax_pv_power_total')|float(0) %}

              {% set load = states('sensor.solax_house_load')|float(0) %}

              {% set export = states('sensor.solax_grid_export')|float(0) %}

              {% set import = states('sensor.solax_grid_import')|float(0) %}


              Moment√°lnƒõ je syst√©m nastaven do re≈æimu {% if mode == 'Manual
              Mode' %}aktivn√≠ho vyb√≠jen√≠ baterie{% elif mode == 'Feedin
              Priority' %}prodeje p≈ôebytk≈Ø z fotovoltaiky{% elif mode == 'Back
              Up Mode' %}ukl√°d√°n√≠ p≈ôebytk≈Ø do baterie{% else %}{{ mode|lower
              }}{% endif %}. {% if acum and not maxh %}Doch√°z√≠ k oh≈ôevu vody z
              p≈ôebytk≈Ø, bez zv√Ω≈°en√©ho odbƒõru ze s√≠tƒõ.{% elif maxh %}Je povolen
              maxim√°ln√≠ oh≈ôev ze s√≠tƒõ, tak≈æe voda se m≈Ø≈æe oh≈ô√≠vat i bez
              p≈ôebytk≈Ø.{% else %}Oh≈ôev vody je aktu√°lnƒõ vypnut.{% endif %} {% if
              export > 100 %}Do s√≠tƒõ se pr√°vƒõ prod√°v√° p≈ôibli≈ænƒõ {{
              export|round(0) }} watt≈Ø.{% elif import > 100 %}Ze s√≠tƒõ se
              aktu√°lnƒõ odeb√≠r√° asi {{ import|round(0) }} watt≈Ø.{% else %}Syst√©m
              je moment√°lnƒõ v rovnov√°ze ‚Äì prakticky neprod√°v√° ani nenakupuje.{%
              endif %} Baterie m√° stav nabit√≠ {{ soc|round(0) }}‚ÄØ% a jej√≠ v√Ωkon
              je {{ power|round(0) }} watt≈Ø. Fotovoltaika vyr√°b√≠ {{ fve|round(0)
              }} watt≈Ø a d≈Øm pr√°vƒõ spot≈ôebov√°v√° {{ load|round(0) }} watt≈Ø.
            grid_options:
              columns: 24
              rows: auto
        column_span: 2
      - type: grid
        cards:
          - type: custom:addon-iframe-card
            url: local_mpc_optimizer/
            aspect_ratio: 50%
            grid_options:
              columns: full
              rows: 12
        column_span: 4
    max_columns: 4
