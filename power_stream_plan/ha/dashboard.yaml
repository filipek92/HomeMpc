views:
  - type: sections
    icon: mdi:trending-up
    cards: []
    title: Plán toků energie
    sections:
      - type: grid
        cards:
          - type: entities
            entities:
              - entity: sensor.mpc_charger_use_mode
              - entity: sensor.mpc_acumulation_on
              - entity: sensor.mpc_max_heat_on
              - entity: sensor.mpc_battery_power
              - entity: sensor.solax_battery_capacity
              - entity: sensor.mpc_battery_target
              - entity: sensor.mpc_battery_discharge_current
              - entity: sensor.mpc_debug
                name: Aktální slot
            title: MPC Plán
            state_color: true
          - show_name: true
            show_icon: true
            type: button
            tap_action:
              action: navigate
              navigation_path: /local_mpc_optimizer/ingress
            name: Plánovač
      - type: grid
        cards:
          - type: entities
            entities:
              - entity: switch.tepelnaakumulace_povolen_horn_akumulace
                name: Povolení horní akumulace
              - entity: switch.tepelnaakumulace_povolen_spodn_akumulace
                name: Povolení spodní akumulace
                secondary_info: none
              - entity: switch.tepelnaakumulace_blokov_n_nucen_ho_oh_evu
                name: ' Blokování nuceného ohřevu'
              - entity: switch.tepelnaakumulace_maxim_ln_oh_ev_ze_s_t
                name: Maximální ohřev ze sítě
              - entity: select.solax_charger_use_mode
              - entity: automation.mpc_rizeni_akumulace_a_rezimu_menice
                secondary_info: last-triggered
            state_color: true
            show_header_toggle: false
            title: Akumulace
          - type: entities
            entities:
              - entity: counter.denni_eeprom_zapisy
                name: Denní zápisy EEPROM
          - type: entities
            entities:
              - entity: sensor.tepelnaakumulace_energie_n_dr_e
              - entity: sensor.tepelnaakumulace_nabit_n_dr_e
              - entity: sensor.solax_battery_capacity
              - entity: sensor.mpc_battery_target
      - type: grid
        cards:
          - type: markdown
            content: >
              {#
              ============================================================================
                 🔋 MPC a stav systému – přehledová šablona pro Home Assistant
                 Upravená pro nové atributy sensor.mpc_debug (Ceny v Kč)
              ============================================================================
              #}


              {# --------------------- Sběr dat --------------------- #}

              {% set soc = states('sensor.solax_battery_capacity')|float(0) %}

              {% set target_soc = states('sensor.mpc_battery_target')|float(0)
              %}

              {% set plan_pwr = states('sensor.mpc_battery_power')|float(0) %}

              {% set real_pwr =
              states('sensor.solax_battery_power_charge')|float(0) %}

              {% set b_power = state_attr('sensor.mpc_debug','b_power')|float(0)
              %}

              {% set tuv_target_pct =
              state_attr('sensor.mpc_debug','tuv_soc_target_pct')|float(0) %}


              {% set temp_top =
              states('sensor.tepelnaakumulace_horn_senzor')|float(0) %}

              {% set temp_mid =
              states('sensor.tepelnaakumulace_st_edn_senzor')|float(0) %}

              {% set temp_bot =
              states('sensor.tepelnaakumulace_spodn_senzor')|float(0) %}

              {% set tank_energy =
              states('sensor.tepelnaakumulace_energie_n_dr_e')|float(0) %}

              {% set tank_soc =
              states('sensor.tepelnaakumulace_nabit_n_dr_e')|float(0) %}


              {# --------------------- Barvy pro teplotu ---------------------
              #}

              {% macro temp_icon(t) -%}
                {{- iif(t < 30, '🔵', iif(t < 45, '🟡', '🔴')) -}}
              {%- endmacro %}


              {#
              ============================================================================
                 🧠 Plán MPC
              ============================================================================
              #}

              ## 🧠 Plán MPC (aktuální slot)

              🔋 Režim: {{ states('sensor.mpc_charger_use_mode') }}{% if
              is_state('sensor.mpc_charger_use_mode','Manual Mode') %} → aktivní
              vybíjení{% elif is_state('sensor.mpc_charger_use_mode','Feedin
              Priority') %} → přetoky z FVE{% elif
              is_state('sensor.mpc_charger_use_mode','Back Up Mode') %} →
              záložní režim{% endif %} • ♨️ {{ 'TUV' if
              is_state('sensor.mpc_acumulation_on','True') else '~~TUV~~' }} •
              🔥 {{ 'Max-heat' if is_state('sensor.mpc_max_heat_on','True') else
              '~~Max-heat~~' }} • 🎯 Cíl: {{ target_soc|round(1) }}% • ⚡ Plán:
              {{ plan_pwr|round(0) }}W  

              🔋 b_power: {{ b_power|float(0)|round(2) }}kW • 📥 b_charge: {{
              state_attr('sensor.mpc_debug','b_charge')|float(0)|round(2) }}kW •
              📤 b_discharge: {{
              state_attr('sensor.mpc_debug','b_discharge')|float(0)|round(2)
              }}kW  

              🔌 g_sell: {{
              state_attr('sensor.mpc_debug','g_sell')|float(0)|round(2) }}kW •
              📥 g_buy: {{
              state_attr('sensor.mpc_debug','g_buy')|float(0)|round(2) }}kW  

              💲 Nákup: {{
              state_attr('sensor.mpc_debug','buy_cost')|float(0)|round(2) }}Kč •
              💰 Prodej: {{
              state_attr('sensor.mpc_debug','sell_income')|float(0)|round(2)
              }}Kč • 🧾 Bilance: {{
              state_attr('sensor.mpc_debug','net_step_cost')|float(0)|round(2)
              }}Kč


              ---


              ## ⚡ Reálný stav měniče a baterie

              🧩 Měnič: {{ states('sensor.solax_run_mode')|default('–') }} •
              Výkon: {{ states('sensor.solax_inverter_power')|default('–') }}W •
              Teplota: {{
              states('sensor.solax_inverter_temperature')|default('–') }}°C  

              🔋 SOC: {{ soc|round(1) }}% • Výkon: {{ real_pwr|round(0) }}W •
              Napětí: {{
              states('sensor.solax_battery_voltage_charge')|default('–') }}V •
              Teplota: {{
              states('sensor.solax_battery_temperature')|default('–') }}°C  

              ☀️ PV: {{ states('sensor.solax_pv_power_total')|default('–') }}W •
              🏠 Dům: {{ states('sensor.solax_house_load')|default('–') }}W • 📤
              Export: {{ states('sensor.solax_grid_export')|default('–') }}W •
              📥 Import: {{ states('sensor.solax_grid_import')|default('–') }}W


              ---


              ## 🛢️ Akumulační nádrž

              🔼 {{ temp_icon(temp_top) }} {{ temp_top|round(1) }}°C • 🔁 {{
              temp_icon(temp_mid) }} {{ temp_mid|round(1) }}°C • 🔽 {{
              temp_icon(temp_bot) }} {{ temp_bot|round(1) }}°C • 🔋 {{
              tank_energy|round(1) }}kWh • SOC: {{ tank_soc|round(1) }}%  

              💧 H_SOC: {{
              state_attr('sensor.mpc_debug','h_soc_percent')|float(0)|round(1)
              }}% ({{ state_attr('sensor.mpc_debug','h_soc')|float(0)|round(2)
              }}kWh) • H_in: {{
              state_attr('sensor.mpc_debug','h_in')|float(0)|round(2) }}kW •
              H_out: {{ state_attr('sensor.mpc_debug','h_out')|float(0)|round(2)
              }}kW


              ---


              ## ⚙️ Finance & výkon

              📊 Dobito: {{
              state_attr('sensor.mpc_debug','total_charged')|float(0)|round(2)
              }}kWh • Vybito: {{
              state_attr('sensor.mpc_debug','total_discharged')|float(0)|round(2)
              }}kWh  

              💲 Náklady: {{
              state_attr('sensor.mpc_debug','total_buy_cost')|float(0)|round(2)
              }}Kč • 💰 Výnosy: {{
              state_attr('sensor.mpc_debug','total_sell_income')|float(0)|round(2)
              }}Kč • 🧾 Čistá bilance: {{
              state_attr('sensor.mpc_debug','net_bilance')|float(0)|round(2)
              }}Kč  

              🔥 Boiler: {{
              state_attr('sensor.mpc_debug','total_final_boiler_value')|float(0)|round(2)
              }}Kč • ☀️ Nevyužito PV: {{
              state_attr('sensor.mpc_debug','total_fve_unused')|float(0)|round(2)
              }}kWh  

              📈 Pen_batt: {{
              state_attr('sensor.mpc_debug','total_battery_penalty')|float(0)|round(2)
              }}Kč • Pen_under: {{
              state_attr('sensor.mpc_debug','total_battery_under_penalty')|float(0)|round(2)
              }}Kč • Pen_PV: {{
              state_attr('sensor.mpc_debug','total_fve_unused_penalty')|float(0)|round(2)
              }}Kč  

              📈 PriceAbove: {{
              state_attr('sensor.mpc_debug','total_bat_price_above')|float(0)|round(2)
              }} • PriceBelow: {{
              state_attr('sensor.mpc_debug','total_bat_price_below')|float(0)|round(2)
              }} • Obj: {{
              state_attr('sensor.mpc_debug','objective_value')|float(0)|round(2)
              }}Kč?


              ---


              {#
              ============================================================================
                 ⚠️ Varování – soulady a nesoulesy
              ============================================================================
              #}

              {% set warn_msgs = [] %}

              {% if soc - target_soc > 5 and
              is_state('sensor.mpc_charger_use_mode','Manual Mode') %}
                {% do warn_msgs.append('🔋 SOC ' ~ soc|round(1) ~ '% (> cíl), ale stále se vybíjí') %}
              {% endif %}

              {% if target_soc - soc > 5 and
              is_state('sensor.mpc_charger_use_mode','Back Up Mode') and
              real_pwr < 100 %}
                {% do warn_msgs.append('🔋 SOC ' ~ soc|round(1) ~ '% (< cíl), ale nenabíjí se (' ~ real_pwr ~ ' W)') %}
              {% endif %}

              {% if plan_pwr < -100 and real_pwr > -100 %}
                {% do warn_msgs.append('📤 Plánuje se vybíjení ' ~ plan_pwr|round(0) ~ ' W, ale baterie nevybíjí') %}
              {% endif %}

              {% if plan_pwr > 100 and real_pwr < 100 %}
                {% do warn_msgs.append('📥 Plánuje se nabíjení ' ~ plan_pwr|round(0) ~ ' W, ale baterie nenabíjí') %}
              {% endif %}

              {% if not is_state('sensor.solax_run_mode','Normal Mode') %}
                {% do warn_msgs.append('🧩 Měnič není v režimu Normal Mode') %}
              {% endif %}

              {% if is_state('sensor.mpc_acumulation_on','True') and
              is_state('switch.tepelnaakumulace_povolen_horn_akumulace','off')
              and
              is_state('switch.tepelnaakumulace_povolen_spodn_akumulace','off')
              %}
                {% do warn_msgs.append('♨️ MPC požaduje TUV, ale spirály jsou vypnuté') %}
              {% endif %}

              {% if is_state('sensor.mpc_max_heat_on','True') and
              is_state('switch.tepelnaakumulace_maxim_ln_oh_ev_ze_s_t','off') %}
                {% do warn_msgs.append('🔥 Max-heat je požadován, ale vypnutý') %}
              {% endif %}

              {% if is_state('sensor.mpc_acumulation_on','True') and tank_soc <
              tuv_target_pct - 10 %}
                {% do warn_msgs.append('♨️ Nádrž má nabití jen ' ~ tank_soc|round(1) ~ '%, cíl je ' ~ tuv_target_pct|round(1) ~ '%') %}
              {% endif %}

              {% if is_state('sensor.mpc_acumulation_on','True') and temp_top <
              45 %}
                {% do warn_msgs.append('🌡️ Horní část nádrže má jen ' ~ temp_top ~ ' °C') %}
              {% endif %}

              {% if is_state('sensor.mpc_acumulation_on','True') and temp_bot <
              30 %}
                {% do warn_msgs.append('🌡️ Spodní část nádrže je jen ' ~ temp_bot ~ ' °C') %}
              {% endif %}

              {% if is_state('sensor.mpc_acumulation_on','True') and plan_pwr >
              500 and real_pwr < 100 %}
                {% do warn_msgs.append('🔥 Požaduje se ohřev, ale výkon spirály je nízký (' ~ real_pwr ~ ' W)') %}
              {% endif %}

              {% if states('sensor.solax_battery_temperature')|float > 50 %}
                {% do warn_msgs.append('⚠️ Vysoká teplota baterie: ' ~ states('sensor.solax_battery_temperature') ~ ' °C') %}
              {% endif %}


              {% if warn_msgs | length > 0 %}

              ## ⚠️ Varování

              {% for msg in warn_msgs %}- {{ msg }} {% endfor %}

              {% else %}

              ✅ Vše v pořádku – plán a realita jsou v souladu.

              {% endif %}
            grid_options:
              columns: 24
              rows: auto
            text_only: true
          - type: markdown
            content: >
              {% set mode = states('sensor.mpc_charger_use_mode') %}

              {% set acum = is_state('sensor.mpc_acumulation_on', 'True') %}

              {% set maxh = is_state('sensor.mpc_max_heat_on', 'True') %}

              {% set soc = states('sensor.solax_battery_capacity')|float(0) %}

              {% set power =
              states('sensor.solax_battery_power_charge')|float(0) %}

              {% set fve = states('sensor.solax_pv_power_total')|float(0) %}

              {% set load = states('sensor.solax_house_load')|float(0) %}

              {% set export = states('sensor.solax_grid_export')|float(0) %}

              {% set import = states('sensor.solax_grid_import')|float(0) %}


              Momentálně je systém nastaven do režimu {% if mode == 'Manual
              Mode' %}aktivního vybíjení baterie{% elif mode == 'Feedin
              Priority' %}prodeje přebytků z fotovoltaiky{% elif mode == 'Back
              Up Mode' %}ukládání přebytků do baterie{% else %}{{ mode|lower
              }}{% endif %}. {% if acum and not maxh %}Dochází k ohřevu vody z
              přebytků, bez zvýšeného odběru ze sítě.{% elif maxh %}Je povolen
              maximální ohřev ze sítě, takže voda se může ohřívat i bez
              přebytků.{% else %}Ohřev vody je aktuálně vypnut.{% endif %} {% if
              export > 100 %}Do sítě se právě prodává přibližně {{
              export|round(0) }} wattů.{% elif import > 100 %}Ze sítě se
              aktuálně odebírá asi {{ import|round(0) }} wattů.{% else %}Systém
              je momentálně v rovnováze – prakticky neprodává ani nenakupuje.{%
              endif %} Baterie má stav nabití {{ soc|round(0) }} % a její výkon
              je {{ power|round(0) }} wattů. Fotovoltaika vyrábí {{ fve|round(0)
              }} wattů a dům právě spotřebovává {{ load|round(0) }} wattů.
            grid_options:
              columns: 24
              rows: auto
        column_span: 2
      - type: grid
        cards:
          - type: custom:addon-iframe-card
            url: local_mpc_optimizer/
            aspect_ratio: 50%
            grid_options:
              columns: full
              rows: 12
        column_span: 4
    max_columns: 4
